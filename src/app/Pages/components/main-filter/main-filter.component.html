<div>
  <div>
    <div class="preview-label">Preview</div>
    <div nz-row>
      <div nz-col nzSpan="24" class="preview-container">
        {{ filterData.SHOW_QUERY }}
      </div>
    </div>
  </div>
  <div class="filter-container">
    <div *ngFor="let group of filterGroups; let i = index">
      <div nz-row>
        <div
          *ngIf="filterGroups.length > 1 && i != 0"
          nz-col
          nzSpan="24"
          class="group-separator"
        >
          <div class="group-connector-top"></div>
          <nz-select
            name="LogicalOperator{{ i }}"
            [(ngModel)]="group.operator"
            class="logical-operator"
          >
            <nz-option nzValue="AND" nzLabel="AND"></nz-option>
            <nz-option nzValue="OR" nzLabel="OR"></nz-option>
          </nz-select>
          <div class="group-connector-bottom"></div>
        </div>
        <div nz-col nzSpan="24" class="group-header">
          <span class="group-label"> Group {{ i + 1 }} </span>
        </div>
        <div nz-col nzSpan="24" class="conditions-container">
          <div
            class="condition-wrapper"
            *ngFor="let conditionObj of group.conditions; let j = index"
          >
            <div nz-row [nzGutter]="16">
              <div nz-col class="gutter-row condition-operator-col" nzSpan="2">
                <div *ngIf="j > 0" class="condition-connector-top"></div>
                <div *ngIf="j > 0" class="condition-operator-select">
                  <nz-select
                    name="operator{{ i }}{{ j }}"
                    [(ngModel)]="filterGroups[i].conditions[j].operator"
                    nzSize="small"
                    (ngModelChange)="setValue('operator', i, j, $event)"
                  >
                    <nz-option nzValue="AND" nzLabel="AND"></nz-option>
                    <nz-option nzValue="OR" nzLabel="OR"></nz-option>
                  </nz-select>
                </div>
                <div *ngIf="j > 0" class="condition-connector-bottom"></div>
              </div>
              <div nz-col class="gutter-row" nzSpan="8">
                <nz-select
                  name="Selectorsss{{ i }}{{ j }}"
                  [(ngModel)]="filterGroups[i].conditions[j].condition.field"
                  (ngModelChange)="
                    onFieldChange(
                      filterGroups[i].conditions[j].condition,
                      $event,
                      i,
                      j
                    )
                  " class="w-100" 
                  nzPlaceHolder="Select Column Name"
                >
                  <nz-option
                    *ngFor="let field of fields"
                    [nzValue]="field.key"
                    [nzLabel]="field.label"
                  ></nz-option>
                </nz-select>
              </div>
              <div nz-col class="gutter-row" nzSpan="5">
                <nz-select
                  name="Comparator{{ i }}{{ j }}"
                  [(ngModel)]="
                    filterGroups[i].conditions[j].condition.comparator
                  "
                  (ngModelChange)="
                    setValue('condition.comparator', i, j, $event)
                  "
                  nzPlaceHolder="Select Comparator" class="w-100"
                >
                  <nz-option
                    *ngFor="
                      let comparator of getComparators(
                        filterGroups[i].conditions[j].condition.field
                      )
                    "
                    [nzValue]="comparator.value"
                    [nzLabel]="comparator.display"
                  ></nz-option>
                </nz-select>
              </div>
              <div nz-col class="gutter-row" nzSpan="8">
                <input
                  name="value{{ i }}{{ j }}"
                  *ngIf="
                    isInputField(
                      filterGroups[i].conditions[j].condition.field
                    ) == false &&
                    isDateField(
                      filterGroups[i].conditions[j].condition.field
                    ) == false &&
                    isTimeField(
                      filterGroups[i].conditions[j].condition.field
                    ) == false &&
                    isSelectField(
                      filterGroups[i].conditions[j].condition.field
                    ) == false &&
                    isSearchField(
                      filterGroups[i].conditions[j].condition.field
                    ) == false
                  "
                  nz-input
                  disabled
                />
                <input
                  name="value{{ i }}{{ j }}"
                  *ngIf="
                    isInputField(filterGroups[i].conditions[j].condition.field)
                  "
                  nz-input
                  [(ngModel)]="filterGroups[i].conditions[j].condition.value"
                  (ngModelChange)="setValue('condition.value', i, j, $event)"
                  [placeholder]="
                    getPlaceholder(
                      filterGroups[i].conditions[j].condition.field
                    )
                  "
                />
                <input
                  name="value{{ i }}{{ j }}"
                  *ngIf="
                    isSearchField(filterGroups[i].conditions[j].condition.field)
                  "
                  nz-input
                  [(ngModel)]="filterGroups[i].conditions[j].condition.value"
                  (input)="onInput($event, i, j)"
                  (ngModelChange)="setValue('condition.value', i, j, $event)"
                  [placeholder]="
                    getPlaceholder(
                      filterGroups[i].conditions[j].condition.field
                    )
                  "
                  [nzAutocomplete]="auto"
                />
                <nz-autocomplete
                  [nzDataSource]="filteredOptions"
                  (nzSelect)="onSelect($event, i, j)"
                  nzBackfill
                  #auto
                ></nz-autocomplete>
                <nz-date-picker
                  name="value{{ i }}{{ j }}"
                  *ngIf="
                    isDateField(filterGroups[i].conditions[j].condition.field)
                  "
                  [(ngModel)]="filterGroups[i].conditions[j].condition.value"
                  (ngModelChange)="setValue('condition.value', i, j, $event)"
                  [nzFormat]="'dd/MM/yyyy'"
                  [nzPlaceHolder]="
                    getPlaceholder(
                      filterGroups[i].conditions[j].condition.field
                    )
                  "
                ></nz-date-picker>
                <nz-time-picker
                  name="value{{ i }}{{ j }}"
                  *ngIf="
                    isTimeField(filterGroups[i].conditions[j].condition.field)
                  "
                  [(ngModel)]="filterGroups[i].conditions[j].condition.value"
                  (ngModelChange)="setValue('condition.value', i, j, $event)"
                  [nzFormat]="'HH:mm a'"
                  [nzPlaceHolder]="
                    getPlaceholder(
                      filterGroups[i].conditions[j].condition.field
                    )
                  "
                ></nz-time-picker>
                <nz-select
                  name="value{{ i }}{{ j }}"
                  *ngIf="
                    isSelectField(filterGroups[i].conditions[j].condition.field)
                  "
                  [(ngModel)]="filterGroups[i].conditions[j].condition.value"
                  (ngModelChange)="setValue2('condition.value', i, j, $event)"
                  nzShowSearch
                  [nzPlaceHolder]="
                    getPlaceholder(
                      filterGroups[i].conditions[j].condition.field
                    )
                  "
                >
                  <nz-option
                    *ngFor="
                      let option of getOptions(
                        filterGroups[i].conditions[j].condition.field
                      )
                    "
                    [nzValue]="option.value"
                    [nzLabel]="option.display"
                  ></nz-option>
                </nz-select>
              </div>
              <div nz-col class="gutter-row remove-condition-col" nzSpan="1">
                <span
                  class="remove-condition-active"
                  [nzTooltipTitle]="'Remove this rule'"
                  nz-tooltip
                  *ngIf="group.conditions.length > 1"
                  (click)="removeCondition(i, j)"
                  nz-icon
                  nzType="delete"
                ></span>
                <span
                  class="remove-condition-disabled"
                  [nzTooltipTitle]="
                    'Group must contains atleast one rule.You can not remove this rule.'
                  "
                  nz-tooltip
                  *ngIf="group.conditions.length == 1"
                  nz-icon
                  nzType="delete"
                ></span>
              </div>
            </div>
          </div>
          <div class="condition-actions">
            <span
              *ngIf="filterGroups.length > 1"
              (click)="removeGroup(i)"
              class="action-btn remove-group-btn"
            >
              <i class="icon-size-4" nz-icon nzType="delete"></i>
              Remove Group {{ i + 1 }}
            </span>
            <span
              (click)="addCondition(i, group.conditions.length - 1)"
              class="action-btn add-rule-btn"
            >
              <span nz-icon nzType="plus-circle" nzTheme="outline"></span>
              Insert New Rule
            </span>
          </div>
        </div>
      </div>
    </div>
    <div class="add-group-section">
      <span (click)="addGroup()" class="add-group-link">
        <span
          nz-icon
          nzType="plus-circle"
          nzTheme="outline"
          class="add-group-icon"
        ></span>
        <br />
        New Group
      </span>
    </div>
  </div>
</div>
<div class="footer">
  <div class="filter-actions">
    <button nz-button (click)="resetFilters()">Reset All</button>
    <button
      nz-button
      *ngIf="filterData['ID'] == null || filterData['ID'] == undefined"
      nzType="primary"
      (click)="openNameModalForApply('SA', '')"
    >
      <span nz-icon nzType="filter"></span> Apply & Save Filter
    </button>
    <button
      nz-button
      nzType="primary"
      (click)="openNameModal('SC', '')"
      *ngIf="editButton == 'N'"
    >
      <span nz-icon nzType="filter"></span> Save Filter
    </button>
    <button
      nz-button
      nzType="primary"
      (click)="updateFilter('UF', filterData['ID'])"
      *ngIf="editButton == 'Y'"
    >
      <span nz-icon nzType="filter"></span> Update Filter
    </button>
  </div>
</div>
<form (ngSubmit)="saveFilter('', false)">
  <nz-modal
    [(nzVisible)]="isVisible"
    [nzTitle]="'Enter Name For Filter'"
    (nzOnCancel)="handleCancel()"
    nzOkText="Save & Close"
    (nzOnOk)="handleOk()"
    [nzOkLoading]="loading"
  >
    <ng-container *nzModalContent>
      <input
        nz-input
        [(ngModel)]="name"
        name="name"
        maxlength="128"
        placeholder="Enter Special Instruction"
        autocomplete="off"
      />
      <span class="char-counter" *ngIf="name">{{ name.length }}/128</span>
    </ng-container>
  </nz-modal>
</form>
