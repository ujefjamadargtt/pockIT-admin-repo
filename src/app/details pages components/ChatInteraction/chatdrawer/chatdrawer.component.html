<div class="chat-container">
  <div class="refresh-container">
    <span
      nz-tooltip
      nzTooltipTitle="Refresh Chat"
      nz-icon
      nzType="reload"
      nzTheme="outline"
      [nzSpin]="msgspin"
      (click)="getmsgs()"
    ></span>
  </div>
  <div class="message-box" id="scrollableDivvvvv" #scrollableDivvvvv>
    <div *ngIf="groupeddata != undefined && groupeddata != null">
      <nz-spin [nzSpinning]="msgspin">
        <div *ngFor="let msgdate of getKeys(groupeddata)">
          <div class="date-header">
            {{ msgdate | date : "dd/MM/yyyy" }}
          </div>
          <div *ngFor="let messageeee of groupeddata[msgdate]">
            <div
              class="message customer-message"
              *ngIf="messageeee['MSG_SEND_BY'] == 'T'"
            >
              <span class="customer-name">{{
                messageeee["TECHNICIAN_NAME"]
              }}</span>
              <div class="message-content">
                <div class="message-text">
                  {{ messageeee["MESSAGE"] }}
                  <div
                    *ngIf="
                      messageeee['ATTACHMENT_URL'] != null &&
                      messageeee['ATTACHMENT_URL'] != '' &&
                      messageeee['ATTACHMENT_URL'] != undefined
                    "
                    class="attachment-container"
                  >
                    <img
                      *ngIf="
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'png' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'jpeg' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'jpg' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'avif' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() == 'jifi'
                      "
                      nz-image
                      class="chat-image"
                      nzSrc="{{ urllll }}JobChat/{{
                        messageeee['ATTACHMENT_URL']
                      }}"
                      alt=""
                    />
                    <video
                      class="chat-video"
                      controls
                      *ngIf="
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'mp4' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'mov' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'avi' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() ==
                          'wmv' ||
                        messageeee['ATTACHMENT_URL'].split('.').pop() == 'mkv'
                      "
                    >
                      <source
                        src="{{ urllll }}JobChat/{{
                          messageeee['ATTACHMENT_URL']
                        }}"
                        type="video/mp4"
                      />
                    </video>
                  </div>
                </div>
                <div class="timestamp-right">
                  {{ messageeee["SEND_DATE"] | date : "dd/MM | HH:mm a" }}
                </div>
              </div>
            </div>
            <div
              class="message technician-message"
              *ngIf="messageeee['MSG_SEND_BY'] == 'B'"
            >
              <span class="technician-name">{{
                messageeee["SENDER_USER_ID_USER"]
              }}</span>
              <div class="message-content">
                <div
                  class="message-text"
                  [innerHTML]="transform(messageeee['MESSAGE'])"
                ></div>
                <div
                  *ngIf="
                    messageeee['ATTACHMENT_URL'] != null &&
                    messageeee['ATTACHMENT_URL'] != '' &&
                    messageeee['ATTACHMENT_URL'] != undefined
                  "
                  class="attachment-container"
                >
                  <img
                    *ngIf="
                      messageeee['ATTACHMENT_URL'].split('.').pop() == 'png' ||
                      messageeee['ATTACHMENT_URL'].split('.').pop() == 'jpeg' ||
                      messageeee['ATTACHMENT_URL'].split('.').pop() == 'jpg'
                    "
                    nz-image
                    class="chat-image"
                    nzSrc="{{ urllll }}JobChat/{{
                      messageeee['ATTACHMENT_URL']
                    }}"
                    alt=""
                  />
                  <video
                    class="chat-video"
                    controls
                    *ngIf="
                      messageeee['ATTACHMENT_URL'].split('.').pop() == 'mp4'
                    "
                  >
                    <source
                      src="{{ urllll }}JobChat/{{
                        messageeee['ATTACHMENT_URL']
                      }}"
                      type="video/mp4"
                    />
                    <source src="movie.ogg" type="video/ogg" />
                  </video>
                </div>
              </div>
              <span class="timestamp-left">
                {{ messageeee["SEND_DATE"] | date : "dd/MM | HH:mm a" }}</span
              >
            </div>
          </div>
        </div>
      </nz-spin>
    </div>
  </div>
  <div *ngIf="showimagebox" class="image-preview-container">
    <img
      *ngIf="
        ICON.split('.').pop() == 'png' ||
        ICON.split('.').pop() == 'jpeg' ||
        ICON.split('.').pop() == 'jpg'
      "
      nz-image
      class="preview-image"
      nzSrc="{{ urllll }}JobChat/{{ ICON }}"
      alt=""
    />
    <video
      class="preview-video"
      controls
      *ngIf="ICON.split('.').pop() == 'mp4'"
    >
      <source src="{{ urllll }}JobChat/{{ ICON }}" type="video/mp4" />
    </video>
  </div>
  <nz-spin [nzSpinning]="isSpinning">
    <div class="input-area">
      <button
        nz-button
        nzType="default"
        class="paper-clip-btn"
        *ngIf="!progressBarImageOne"
      >
        <span
          (click)="fileInput.click()"
          class="paper-clip-icon"
          nz-icon
          nzType="paper-clip"
          nzTheme="outline"
        ></span>
      </button>
      <nz-progress
        [nzPercent]="percentImageOne"
        [nzWidth]="30"
        nzType="circle"
        *ngIf="progressBarImageOne"
        class="upload-progress"
      ></nz-progress>
      <input
        accept="image/*,video/*"
        #fileInput
        name="albumimage"
        type="file"
        (change)="onFileSelected($event)"
        class="file-input"
        required
      />
      <textarea
        placeholder="Type your message..."
        rows="1"
        #textArea
        id="messages2"
        (mouseup)="onEditorMouseUp($event)"
        (mousedown)="onEditorMouseUp($event)"
        (mousemove)="onEditorMouseUp($event)"
        (mouseenter)="onEditorMouseUp($event)"
        (mouseleave)="onEditorMouseUp($event)"
        (input)="checkInput1()"
        (keyup)="checkCurlyBraces($event)"
        (keydown)="handleEnter($event)"
        [(ngModel)]="BODY_TEXT"
        name="BODY_TEXT"
        class="message-textarea"
      ></textarea>
      <div class="send-button-container">
        <button type="button" class="whatsapp-send-btn" (click)="sendmessage()">
          <span nz-icon nzType="send" nzTheme="outline"></span>
        </button>
      </div>
    </div>
  </nz-spin>
</div>
